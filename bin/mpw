#! /bin/sh -eu
set -o errexit -o nounset

target="${1-.}"

# Workaround for not being able to fusermount from a fusermount directory
# http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=584541
target="$(readlink -f "$target")"
cd /

play_rar() {
    mnt="$(mktemp --tmpdir -d mpw.XXXXXXXXXX)"
    rmtmp() {
        rmdir -- "$mnt"
    }
    trap rmtmp EXIT
    
    rarfs "$1" "$mnt"
    umount() {
        fusermount -u "$mnt"
        rmtmp
    }
    trap umount EXIT
    
    mplayer "$mnt"/*
    
    trap - EXIT
    umount
}

if test ! -d "$target"; then
    play_rar "$target"
elif test "$(find "$target" -maxdepth 1 -name "*.part01.rar" | wc -l)" -ge 1
then
    play_rar "$target"/*.part01.rar
elif test ! -e "$target"/*.rar; then
    echo "$target: No file found" >&2
else
    play_rar "$target"/*.rar
fi
