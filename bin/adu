#! /usr/bin/python3

from subprocess import Popen
import subprocess
from shorthand import fields
from os import fsdecode
from sys import stdout

@fields(param_types=dict(limit=int))
def main(limit, dir):
    du = ("du", "--block-size=1", dir)
    with Popen(du, bufsize=-1, stdout=subprocess.PIPE) as du:
        for line in du.stdout:
            if not line[:1].isdigit():
                continue
            
            (size, file) = line.split(b"\t", 1)
            size = int(size)
            if size < limit:
                continue
            
            pref = ""
            for p in "kMGTPEZY":
                if size < 10000:
                    break
                size //= 1000
                pref = p
            stdout.write("{} {}B\t{}".format(size, pref, fsdecode(file)))

if __name__ == "__main__":
    from funcparams import command
    command()
