(coding: UTF-8)

==== Files

homedot () {
    file="$1"
    local="$HOME/.$1"
}

homedot subversion/config
file=subversion/config local="$APPDATA/Subversion/config"

homedot quiltrc

homedot SciTEUser.properties
file=SciTEUser.properties local="$USERPROFILE/SciTEUser.properties"
# Patch the appropriate path to vhdl properties

file=user.js local="$(echo ~/.mozilla/firefox/*.default)/$file"

file=hosts
local="/etc/hosts"
local="$SYSTEMROOT/system32/drivers/etc/hosts"

homedot profile
homedot Xresources
file=apt.conf local="/etc/apt/apt.conf"
homedot curlrc
homedot env
homedot gnomerc
homedot snmp/snmp.conf
homedot snmp/snmptrapd.conf

==== installing

cp "$file" "$local"

regedit k-meleon-user.reg

regedit content-types-mach.reg

regedit -s putty.reg

==== updating

diff -up "$file" "$local"
cp "$local" "$file"
"$EDITOR" "$local"

regedit -e putty.reg 'HKEY_CURRENT_USER\Software\SimonTatham\PuTTY'

==== Things

=== gconf

DPI: delete from
~/.gconf/desktop/gnome/font_rendering/%gconf.xml
/var/lib/gconf/debian.defaults/%gconf-tree.xml
/usr/share/gconf/defaults/10_libgnome2-common

# Was <Alt>Escape, which prevents cancelling of Alt-Tab
gconftool-2 --set --type string /apps/metacity/global_keybindings/cycle_windows disabled

=== IPADDR

export IPADDR="`ip addr show dev eth0 | sed -n 's/^ *inet \([0-9.]*\).*$/\1/p'`"

=== Environment

set +H
set -u
PREFIX=k:
#BIN="$PREFIX/programs"
#OPT="$PREFIX/programs"
BIN="$PREFIX/bin"
OPT="$PREFIX/opt"
PUB=k:/home/pub
STORE=~/store

# Maybe for CopSSH (Cygwin)?
export APPDATA="$USERPROFILE/Application Data"

PYTHONDIR="$SYSTEMDRIVE/Python25"
export PYTHON="$PYTHONDIR/python"

# Cannot specify "Program Files" because it contains spaces. Cannot specify
# in terms of DOS 8.3 file names because the Autotools scripts use the tilde
# (~) character as a command separator.
#DBROOTDIR="$PROGRAMFILES/Sleepycat Software/Berkeley DB 4.4.20"
#DBROOTDIR="$SYSTEMDRIVE/progra~1/sleepy~1/berkel~1.20"
DBROOTDIR="$PREFIX/programs/db-4.4"
#DBROOTDIR="$OPT/db-4.4"

EXPAT="$SYSTEMDRIVE/Expat-1.95.8"

cache_cat () {
    local cache="$1/$(basename "$2")"
    if test -e "$cache"; then
        cat "$cache"
    else
        wget "$2" -O - |
        tee "$cache"
    fi
}

=== Linux

sysctl -w net.ipv4.conf.all.arp_ignore=1

=== K-meleon

== $APPDATA/K-Meleon/profiles.ini

[General]
StartWithLastProfile=1

=== Firefox

PROFILE="$(echo ~/.mozilla/firefox/*.default)"

== $PROFILE/localstore.rdf

  <RDF:Description RDF:about="chrome://browser/content/browser.xul#toolbar-menubar"
                   iconsize="small"
                   currentset="menubar-items,search-container,unified-back-forward-button,reload-button,stop-button,throbber-box" />
  <RDF:Description RDF:about="chrome://browser/content/browser.xul#nav-bar"
                   iconsize="small"
                   currentset="urlbar-container" />

=== Windows

gpedit.msc
Local Computer Policy/Computer Configuration/Administrative Templates/Windows Components/Windows Update/No auto-restart for scheduled Automatic Update installation

=== Group permissions

uucp (Arch)
dialout (Debian)
network (Arch); netdev (Debian)

==== howto
=== CVS

# this must save the password in some global cache
cvs -d :pserver:anoncvs@cvs.andrew.cmu.edu:/cvs login

# check out tag (-r), specifying working copy dir name (-d)
cvs -d :pserver:anoncvs@cvs.andrew.cmu.edu:/cvs \
    co -r sasl-2_1_22 -d sasl-2_1_22 src/sasl

==== packages

=== Subversion 1.5.5

Requires:
+ Open SSL 0.9.8h
+ Expat 1.95.8
+ Neon 0.28.3
+ Berkeley DB 4.4.20
+ Cyrus SASL 2.1.22
+ APR 1.3.3
# Depends on APR, APR-util
+ Serf

export QUILT_PATCHES=../patches
quilt push -a
./autogen.sh
./configure \
    CPPFLAGS="-I $PREFIX/include -I $PREFIX/include/apr-1 \
        -I $DBROOTDIR/include -I $EXPAT/Source/lib -I $PREFIX/include/sasl \
        -I $PREFIX/include/neon \
        -D _WIN32_IE=0x0500 \
        -D SVN_LOCALE_RELATIVE_PATH"='\"../share/locale\"' \
    LDFLAGS="-L $BIN -L $PREFIX/lib" \
    LIBS="$DBROOTDIR/bin/libdb44.dll" \
    --disable-keychain \
    --disable-nls \
    --without-apache --without-apxs \
    --with-neon --with-serf \
    --without-trang \
    --with-berkeley-db \
    --with-sasl --with-ssl \
    --without-jdk --without-swig
make

=== Expat 1.95.8

=== Neon 0.28.3
patch -p0 < autotools-lib-order.diff
./autogen.sh
./configure \
    CPPFLAGS="-I $PREFIX/include -I $EXPAT/Source/lib" \
    LDFLAGS="-L $PREFIX/lib -L $EXPAT/Libs" LIBS="-lgdi32" \
    --enable-webdav \
    --with-zlib --with-ssl=openssl --with-expat
make
make install-headers prefix="$PREFIX"
install -D src/.libs/libneon.a "$PREFIX/lib"
strip "$PREFIX/lib/libneon.a"

=== Berkeley DB 4.4.20
patch -p0 -d "$DBROOTDIR/include" << DIFF
--- db.h
+++ db.h
@@ -74,11 +74,6 @@
 typedef unsigned int u_int;
 typedef unsigned long u_long;
 #endif
-#ifdef _WIN64
-typedef int64_t ssize_t;
-#else
-typedef int32_t ssize_t;
-#endif
 
 /*
  * uintmax_t --
DIFF

=== Cyrus SASL 2.1.22
patch -p1 < cyrus-sasl-2.1.22-mingw.diff
./configure \
    --disable-gssapi \
    LIBS="-lgdi32 -lws2_32" \
    --with-dblib=berkeley --with-bdb-libdir="$DBROOTDIR/bin" \
    --with-bdb-incdir="$DBROOTDIR/include" \
    --without-pam \
    --without-saslauthd --without-authdaemond \
    --with-openssl="$PREFIX" \
    --without-opie
make
mkdir -p "$PREFIX/include/sasl" "$BIN"
cp include/{hmac-md5,md5{,global},prop,sasl{,plug,util}}.h \
    "$PREFIX/include/sasl"
cp lib/.libs/libsasl2.dll "$BIN"
strip "$BIN/libsasl2.dll"

=== APR 0.9.17
# Gave up getting configure to run.
# Use dzonatas.configure.in.mingw.patch from
# https://issues.apache.org/bugzilla/show_bug.cgi?id=39814#c15 . Try ignoring
# the failure of the third hunk.
wget --no-check-certificate "https://issues.apache.org/bugzilla/attachment.cgi?id=19735" -O - |
patch -p0
wget --no-check-certificate --content-disposition \
    "https://issues.apache.org/bugzilla/attachment.cgi?id=19735"
svn diff http://svn.apache.org/repos/asf/apr/apr/trunk -c421013 > \
    r421013.configure-mingw.diff
./buildconf
./configure

=== APR 1.3.3
wget http://apache.mirror.aussiehq.net.au/apr/apr-1.3.3.tar.gz -O - |
tar xz
cd apr-1.3.3

svn co http://svn.apache.org/repos/asf/apr/apr/tags/1.3.3
cd 1.3.3
PATH="$PATH:$(cd "$PYTHONDIR" && pwd)" ./buildconf
dos2unix config.layout

patch -p0 < ../include-tlhelp32.diff
./configure --without-libtool
make TARGET_LIB=apr-1.dll LINK='$(CC) $(LDFLAGS) -shared -o $@ $^'
mkdir -p "$BIN" "$PREFIX/include/apr-1" "$PREFIX/include/apr-1/arch/win32"
cp include/apr{,_*}.h "$PREFIX/include/apr-1"
# Subversion seems to require this header, even though the makefile does not
# install it and it says it is internal.
cp include/arch/win32/apr_arch_utf8.h "$PREFIX/include/apr-1/arch/win32"
cp apr-1.dll "$BIN"
strip "$BIN/apr-1.dll"
cp build/apr_rules.out "$PREFIX/share/apr-1/build/apr_rules.mk"

=== APR-util 0.9.15
# Gave up (depends on APR 0.9.17)
./configure --with-berkeley-db="$DBROOTDIR" --with-expat="$EXPAT"

=== APR-util 1.3.4
cat "$PUB/software/programming/libraries/apr-util-1.3.4.tar.gz" | tar xz
cd apr-util-1.3.4
# apply patches
rm -f autom4te.cache/traces.0 # otherwise things don't get regenerated!
autoconf
db_real="$(cd "$DBROOTDIR" && pwd)"
# Specify expat at /usr to avoid any chance of using internal expat
export CPPFLAGS="-I $PREFIX/include/apr-1 -I $EXPAT/Source/lib -D HAVE_SQL_H"
export LDFLAGS="-L $EXPAT/Libs"
./configure \
    APR_BUILD_DIR="$PREFIX/share/apr-1/build" \
    --with-berkeley-db="$db_real/include:$db_real/bin" \
    --without-pgsql --without-sqlite3 --without-sqlite2 --without-freetds \
    --with-odbc \
    --with-expat=/usr \
    --without-iconv
make CPPFLAGS="$CPPFLAGS" LDFLAGS="$LDFLAGS" \
    LIBS="$PREFIX/bin/apr-1.dll" \
    TARGET_LIB=aprutil-1.dll LINK='$(CC) $(LDFLAGS) -shared -o $@ $^' \
    APR_MKEXPORT=':' APR_MKVAREXPORT=':' \
    LINK_MODULE='$(CC) $(ALL_CFLAGS) $(ALL_LDFLAGS) $(APRUTIL_LDFLAGS) \
        -shared' \
    LDADD_dbd_odbc='-lodbc32 $(TARGET_LIB) $(LIBS)'
mkdir -p "$BIN" "$PREFIX/include/apr-1"
cp include/*.h "$PREFIX/include/apr-1"
cp aprutil-1.dll "$BIN"

=== APR 1.2.12, APR-util 1.2.12 prebuilt
# Don't use these because they don't include Berkeley DB.
# Source:
# http://apache.mirror.aussiehq.net.au/apr/binaries/win32/apr-all-1.2.12-win32-x86-msvcrt60.zip
# With $(NAME) = (apr, aprutil)-1, extract bin/lib$(NAME).dll to $BIN, lib/
# (lib, "")$(NAME).lib to $PREFIX/lib, include/(apr, apu)*.h to $PREFIX/
# include

=== Wget
== 1.11.4

PREFIX=k:
cat autotools-lib-order.patch windows.patch set-stdout-binary.merge.patch |
patch -p1
rm -f autom4te.cache/traces.0 # otherwise things don't get regenerated!
./autogen.sh
# Wget should check the more standard "_WIN32" macro rather than "WINDOWS"?
# Autotools wants to link directly to the static Open SSL library files
# rather than simply specifying the library names (which should automatically
# prefer the DLLs).
./configure \
    CPPFLAGS="-D WINDOWS" LIBS="-lws2_32 -lgdi32" \
    --disable-nls \
    --with-ssl --with-libssl-prefix="$PREFIX"
make WINDOWS=yes
cp src/wget.exe "$BIN"
strip "$BIN/wget.exe"

=== Patch

== patch 2.5 msys

Version 2.5 in M sys release "msysCORE-1.0.11-2007.01.19-1.tar.bz2"

seems to work reasonably well with "binary" option. Without the "binary"
option, it always seems to convert the entire file to LF line endings,
despite being run on Windows.

== patch 2.5.4 msys

At least version 2.5.4 in M sys release "msysCORE-1.0.11-20080826.tar.gz"
says

(Stripping trailing CRs from patch.)

but fails to patch any file with CRLF line endings:

+ despite being run on Windows
+ no matter whether the diff file has CRLFs or not
+ with or without the "binary" option

== 2.5.9 gnuwin32 7

Without the "binary" option, CRLF diffs produce CRLF output, but LF diffs
fail an assert. With the "binary" option, it says

(Stripping trailing CRs from patch.)

and converts the output to LF line endings.

== 2.5.9-109-g70df4e4

wget ftp://alpha.gnu.org/gnu/patch/patch-2.5.9-109-g70df4e4.tar.gz -O - |
tar xz
cd patch-2.5.9-109-g70df4e4
wget --content-disposition -P gl/lib \
    "http://git.savannah.gnu.org/gitweb/?p=gnulib.git;a=blob_plain;f=lib/getopt_int.h;hb=9d17a13747f2286970948f17d8e22a81326ae023"
patch -p0 <<DIFF
--- gl/lib/xstrndup.c	2009-05-16 10:14:26 +0000
+++ gl/lib/xstrndup.c	2009-05-16 10:14:24 +0000
@@ -29,8 +29,9 @@
 char *
 xstrndup (const char *string, size_t n)
 {
-  char *s = strndup (string, n);
+  char *s = strdup (string);
   if (! s)
     xalloc_die ();
+  s[n] = 0;
   return s;
 }
--- src/patch.c	2009-05-16 09:44:46 +0000
+++ src/patch.c	2009-05-16 09:44:44 +0000
@@ -1348,7 +1348,6 @@
   else
     {
       outstate->ofp = stdout;
-      stdout = stderr;
     }
 
   outstate->after_newline = true;
--- src/util.c	2009-05-16 12:53:22 +0000
+++ src/util.c	2009-05-16 12:53:18 +0000
@@ -232,6 +232,8 @@
 	  if (debug & 4)
 	    say ("Renaming file %s to %s\n",
 		 quotearg_n (0, to), quotearg_n (1, bakname));
+	  
+	  remove (bakname);
 	  while (rename (to, bakname) != 0)
 	    {
 	      if (errno == try_makedirs_errno)
@@ -282,6 +284,7 @@
 	say ("Renaming file %s to %s\n",
 	     quotearg_n (0, from), quotearg_n (1, to));
 
+      remove (to);
       if (rename (from, to) != 0)
 	{
 	  bool to_dir_known_to_exist = false;
DIFF
patch -p1 < ../patch-seekable.diff
./configure
make GETOPT_H=gl/lib/getopt.h
cp src/patch.exe "$BIN"
strip "$BIN/patch.exe"

== 2.5.9-117-g6d9e60f

cache_cat "$PUB/software/text/diff" \
    ftp://alpha.gnu.org/gnu/patch/patch-2.5.9-117-g6d9e60f.tar.gz |
tar xz
# There are missing files compared to the git repository

== 6d9e60f59a055921a6fb161588fe204e2d359349

gnulib_import () {
    wget -O "gl/$1" \
        "http://git.savannah.gnu.org/gitweb/?p=gnulib.git;a=blob_plain;f=$1;hb=f4b65cf4d3c0db3a822ace20e00bb8971234fbbf"
}

cache_cat "$PUB/software/text/diff" \
    http://git.savannah.gnu.org/cgit/patch.git/snapshot/patch-6d9e60f59a055921a6fb161588fe204e2d359349.tar.gz |
tar xz
cd patch-6d9e60f59a055921a6fb161588fe204e2d359349
echo 2.5.9-117-g6d9e60f > VERSION
patch -p1 < ../patch-seekable.diff
gnulib_import m4/string_h.m4
gnulib_import m4/strnlen.m4
gnulib_import lib/strnlen.c
patch -p1 < ../patch-gnulib.diff
./autogen.sh
./configure
make
cp src/patch.exe "$BIN"
strip "$BIN/patch.exe"

== 2.6.1

tar xzf "$PUB/software/text/diff/patch-2.6.1.tar.gz"
cd patch-2.6.1
./configure
make
# Make file still doesn't build gl/lib/strnlen.o

== 2.6.1-2-g2c4e3ec

UPVER=2.6.1-2-g2c4e3ec
VADVER="$UPVER-vad"
cache_cat "$PUB/software/text/diff" \
    "ftp://alpha.gnu.org/gnu/patch/patch-$UPVER.tar.gz" |
tar xz
cd "patch-$UPVER"
echo "$VADVER" > VERSION
mkdir .pc
cat > .pc/quiltrc << QUILTRC
QUILT_PATCHES=../patches
QUILT_SERIES=series-$VADVER
QUILTRC
quilt upgrade
quilt push -a
./configure
make # Causes configure to re-run
cp src/patch.exe "$BIN"
strip "$BIN/patch.exe"

=== rtmpdump 1.6

wget http://lkcl.net/rtmp/rtmpdump-v1.6.tar.gz -O - |
tar xz
cd rtmpdump
patch Makefile <<'DIFF'
--- Makefile	2009-05-27 09:48:04 +0000
+++ Makefile.new	2009-05-29 12:18:38 +0000
@@ -5,6 +5,7 @@
 CFLAGS=-Wall
 CXXFLAGS=-Wall
 LDFLAGS=-Wall
+LDLIBS=-lssl -lcrypto
 
 all: rtmpdump
 
@@ -12,10 +13,10 @@
 	rm -f *.o
 
 streams: bytes.o log.o rtmp.o AMFObject.o rtmppacket.o streams.o parseurl.o dh.o handshake.o
-	$(CXX) $(LDFLAGS) $^ -o $@_x86 -lpthread -lssl -lcrypto
+	$(CXX) $(LDFLAGS) $^ -o $@_x86 -lpthread $(LDLIBS)
 
 rtmpdump: bytes.o log.o rtmp.o AMFObject.o rtmppacket.o rtmpdump.o parseurl.o dh.o handshake.o
-	$(CXX) $(LDFLAGS) $^ -o $@_x86 -lssl -lcrypto
+	$(CXX) $(LDFLAGS) $^ -o $@_x86 $(LDLIBS)
 
 bytes.o: bytes.cpp bytes.h Makefile
 log.o: log.cpp log.h Makefile
DIFF
make \
    CXXFLAGS="-Wall -I $PREFIX/include" \
    LDLIBS="-lwinmm $PREFIX/programs/libeay32.dll -lws2_32"
cp rtmpdump_x86.exe "$BIN/rtmpdump.exe"
strip "$BIN/rtmpdump.exe"

=== G lib 2.20.3

=== libmms 0.4

Requires G lib
extract libmms-0.4.tar.gz from Launchpad download
cd libmms-0.4

=== mimms 2.3.1

Requires libmms
mimms-3.2.1.tar.bz2 from a savannah.nongnu.org mirror (nongnu.org was down)

=== Quilt 0.48-vad4

upver="0.48"
vadver="vad4+dev"
cache_cat "$STORE/sw" \
cache_cat "$PUB/software/storage/version" \
    "http://mirror.dknss.com/nongnu/quilt/quilt-$upver.tar.gz" |
tar xz
cd "quilt-$upver"
mkdir .pc
echo QUILT_PATCHES=../patches > .pc/quiltrc
quilt upgrade
quilt push -a
autoconf

# Windows
opt="--without-column --without-getopt --without-mktemp"

# Linux
opt="--with-column --with-getopt --without-mktemp"

# Empty prefix means root, so that "$PREFIX/dir" becomes "/dir"
./configure \
    --prefix="" \
    --with-bash --with-cp --with-date --with-perl --with-grep --with-tail \
    --with-tr --with-sed --with-awk \
    --without-pod2man \
    --with-diff --with-patch --with-find \
    --without-diffstat \
    --without-sendmail --without-rpmbuild \
    $opt

# compat_leftover needs executable permissions to work
make VERSION="$upver-vad4+dev" compat_leftover=""
export BUILD_ROOT="$(pwd)/stage"
export BUILD_ROOT="$HOME"
make install
strip "$BUILD_ROOT/lib/quilt/backup-files"*

== TODO

+ quilt fold -d option to apply patch to subdirectory [it already does if you cd]
+ quilt -P option uniform for all operations (eg for "quilt files" the argument is the -P option)
+ steal diff syntax highlighting into separate module (if necessary)
+ make it possible to force colour when piping into less -R
+ quilt push -f; quilt fork; quilt pop doesn't ask for a refresh
+ quilt fold colour
+ quilt diff ../<path> doesn't work even if you're cwd is deep inside the source code tree
+ quilt new <existing file>; quilt pop doesn't change the file; therefore quilt push fails
+ quilt pop doesn't seem to complain about needing refreshing if you delete a file rather than edit it
+ quilt fold -f goes interactive like quilt push -f apparently used to
+ quilt sub scripts don't need the shebang at the top
+ quilt command aliases, without having to add an extra file (then quilt ci = commit :)
+ quilt ref -z but without actually refreshing. Needs thought, like what if you want to get the unrefreshed changes of two patches into the new patch. What if you want to get svn diff (no previous patch) into a new patch? Or explicitly tell it an original file?
+ quilt commit -n(ext); like quilt del -n
+ quilt commit 2 etc, vaguely matching quilt push. Needs more thought
+ quilt commit -n (dry run) conflicts with quilt del -n (next) Maybe just use long option --dry-run
+ quilt commit quick option for -s forget
+ quilt commit -s forget should work even with an empty patch
+ some form of quilt ref -z that doesn't refresh, just creates a new patch with the unrefreshed changes (maybe "new -z"?)
+ quilt push 2 -f only pushed the first one. I notice that you can't do another push if a patch "needs" refreshing
+ empty patch with message treated as a patch that doesn't apply; should be treated as empty patch; cannot refresh yet I must before I pop!!!
+ improve message for quilt commit when a patch isn't refreshed
+ quilt ser -e (to edit series file)
+ quilt add file; quilt pop; quilt add; edit added files; quilt push; quilt pop => deletes the files
+ new version of quilt del refuses to delete topmost patch when earlier patches also modify that file (commit & delete aren't the same)
+ quilt ren doesn't rename to an existing (old) patch name; add a --force option? And howcome quilt new does (mainly) overwrite an existing old patch name?
+ quilt add doesn't work with absolute file names (appends whole absolute path to a directory, so that it looks like xxx.orig/home/user/. . .)
+ Change behaviour so that unrefreshed changes are treated like changes to another file. Quilt pop should still work as long as the patch will reverse-apply. Though technically I guess it may reverse-apply differently to how it will foward-apply.
+ Operation to bring a buried patch to the top. Not sure how it would handle conflicts though.

=== Libtool 1.5.26 (including ltdl library)

http://gnuwin32.sourceforge.net/packages/libtool.htm

The bin file also includes library and include files:
http://gnuwin32.sourceforge.net/downlinks/libtool-bin-zip.php

The lib file only has library and include files (not the DLL):
http://gnuwin32.sourceforge.net/downlinks/libtool-lib-zip.php

=== lib FTDI 0.16

cache_cat "$PUB/software/electronics" \
    http://www.intra2net.com/en/developer/libftdi/download/libftdi-0.16.tar.gz |
tar xz
cd libftdi-0.16

=== Serf 0.2.0

=== cksfv 1.3.14-vad-1

cache_cat "$PUB/software/storage" \
    "http://zakalwe.fi/~shd/foss/cksfv/files/cksfv-1.3.14.tar.gz" |
tar xz
cd cksfv-1.3.14
scp -r nl:/media/frain/store/subjects/computers/software/storage/hash/cksfv.patches patches
quilt push -a
./configure --prefix=""
make
EXE=
EXE=.exe
cp "src/cksfv$EXE" "$BIN/"
strip "$BIN/cksfv$EXE"

=== QPDF 2.1.1

./configure --prefix=""
make
make install DESTDIR="$(pwd)/stage"

=== GREP 2.5.4

mkdir grep
cd grep
# get ftp://ftp.gnu.org/gnu/grep/grep-2.5.4.tar.bz2
tar xjf ~/pkg/grep-2.5.4.tar.bz2
cd grep-2.5.4/
./configure --prefix="" --without-included-gettext --without-included-regex \
    --without-included-getopt
make V=0
export DESTDIR="$(pwd)/stage"
make install-strip
sudo cp --archive "$DESTDIR/bin/grep" /usr/local/bin/

==== Generic/Serial server

always listen on socket

=== Always buffered mode

socat serial > bufferer < mixer
server < buffer-share > mix-in

server < serial-out > serial-in

server-send < serial-out
server-recv > serial-in

same-server
socat server /dev/null

+ Shared server endpoints are always open.
+ Keep shared server data in large "circular" buffer. Circular means that new
    data eventually overwrites old data.
+ Each new connection will have a tail pointer into the shared circular
    buffer to keep track of unwritten data.
+ Write all data in the shared buffer to new client connections.
+ If unforwarded server data overflows a client's unsent part of the shared
    buffer, could:
    + disconnect the client
    + overrun the buffer
+ Write buffered shared data from server to clients if possible before
    reading new data from server, to avoid unnecessarily overrunning the
    buffer or disconnecting clients.
+ Use another smaller buffer to hold data mixed from clients to server.
+ If there is free space in the mix buffer, read from each client.
+ Write any mixed data to server (after reading from clients, to improve
    efficiency).

=== Open on demand

server-ondem {socat serial}

+ When the first client connection is accepted:
    + Start opening the server connection. Try not to block.
+ If server connection fails, notify close connections to all clients.
+ When the last connection is closed, close the server connection.
+ Allocate a smaller buffer to hold data from the shared server. This is
    treated similar to the large circular buffer:
    + client connections use the buffer for data to send
    + if the buffer is overrun, perhaps disconnect the client
    + write old data to clients before reading new data from server
+ Identical rules for mixing data from clients to server.

=== Differences

+ Always buffering server opens serial immediately instead of waiting for a
    connection. Failure can still be notified to each client connection, or
    each new connection can cause a retry.
+ Buffering server sends the whole buffer to each new connection; on-demand
    server doesn't.

==== Network

+ wpa_supplicant likes iwconfig mode managed (or perhaps also auto)

==== Use cases

=== [svnsync] Subversion replication

svnadmin create mirror && cd mirror
touch hooks/pre-revprop-change.bat
echo '#! /bin/sh' > hooks/pre-revprop-change &&
chmod a+x hooks/pre-revprop-change
svnsync initialize "file://$(pwd)" svn+ssh://magicuser@drs-storage/magic

svnsync synchronize "file://$(pwd)"

=== [svnhadd] Subversion ancestor addition

svnhadd() {
    SRC="$1"
    DEST="$2"
    real="$DEST.real"
    mv "$DEST" "$real"
    svn revert "$DEST"
    svn copy "$SRC@BASE" "$DEST"
    mv "$real" "$DEST"
    svn diff "$DEST"
}

=== [svnadmin] Set up existing Subversion repository

svnadmin create <path>
svnadmin load <path> < <dump>

=== [mount.vfat] Mount FAT disk

sudo mount -t vfat -o noatime,umask=0,shortname=winnt,iocharset=utf8

=== ls

ls -go --time-style +"%Y-%m-%d %H:%M:%S"

=== [rsync] Copying files

# Rsync "size-only" option seems to override the "ignore-times" option, so to
# completely disable all size and time "quick checking" you have to
# additionally remove the "size-only" option.

# Replace --size-only with --ignore-times to not skip over same-sized files
# Or use a single -i to hide the skipped-over files
rsync --no-whole-file --inplace --times --size-only --recursive -Pii src/ dest/

=== [pdf_decrypt] Decrypt PDFs

echo -n "$f: "
qpdf --show-encryption "$f"

# Just see the "invalid password" errors
qpdf --show-encryption "$f" > /dev/null

+ QPDF cannot use the same infile and outfile

# Usage: pdf_decrypt <file> [<pass>]
pdf_decrypt() (
    set -o errexit -o nounset -o pipefail
    qpdf ${2+--password=$2} --decrypt --stream-data=preserve "$1" "$1.tmp"
    mv "$1.tmp" "$1"
)

=== Git

sudo apt-get install git-core

git clone git://git.openezx.org/gnufiish.git
cd gnufiish

==== Operations

git show
Gives hash and log of last commit.

git checkout <hash>|master
Change working copy to that particular revision.

git status
git head
git tag -l
git rev-parse [--show-cdup]
git describe [--tags]
git log
git diff
git reset
git show-branch
git annotate <file>

==== General options

--pretty=oneline

--abbrev-commit
Shows first 7 digits of hashes instead of all 40 digits

--no-pager

==== Create repository

git init
Creates .git structure in CWD

# Empty root commit
git commit --author="none <>" --date="" -m "Empty root commit" -n --allow-empty

===== Root commit insertion

# Latch onto an existing initial commit
git checkout <an initial commit> (for example, HEAD~1)

(Find root commits with git log --max-parents=0)

# Create the empty commit
git rm --cached . -r
git commit --author="" --date="" -m "Empty root commit" -n --allow-empty --amend

git tag root

# Remove any working directory files leftover from the checkout because they
# will conflict with child commits
#git clean -f -d
#rm <files>
mkdir stash && mv <valuable files> stash/

# Rebase main trunk branch (master)
git rebase --onto root --root master

# Subsequent branchs
git rebase --onto <equivalent branch point> <previous branch point> <branch>

# Update tags
git tag <equivalent commit> <tag> -f

==== Cardinal commit number

echo "$(git rev-list --count HEAD)-g$(git rev-parse --short HEAD)"

==== Manual merge

# --no-ff is required even when --no-commit is given!
git merge --no-commit --no-ff

=== Linux

# make O=out ARCH=arm CROSS_COMPILE=arm-angstrom-linux-gnueabi- silentoldconfig
make -j 2 O=../out ARCH=arm CROSS_COMPILE=arm-angstrom-linux-gnueabi-
# Now we have out/arch/arm/boot/zImage

# Install modules into out/stage. It also installs absolute symbolic links to
# the kernel source and build directoriesSeems to install a whole lot of other
# stuff: C files, object files.
make O=../out ARCH=arm CROSS_COMPILE=arm-angstrom-linux-gnueabi- \
    modules_install INSTALL_MOD_PATH=../fs

==== digging tunnel

ssh nls -D 3333 -fN
socat

==== Music player

=== Amarok

- apparently requires KDE: 200 MB install

=== Audacious

- winamp UI
    - tiny
    - own "skin"
    o multi windows
+ cue file => playlist
- global volume
- utf-8 looks broken

==== packages

packages depend on a specific "feature"/file/etc

eg pacman depends on libarchive.so.2; libarchive(a) provides libarchive.so.2 and depends on liblzma.so.0; libarchive(b) also provides libarchive.so.2 but depends instead on liblzma.so.5. xz-utils provides liblzma.so.0; xz provides liblzma.so.5

==== distros

=== Debian

tends to get "out of date" and independant debs require lots of things to be updated
uses libnameV to have multiple versions of a library

=== Ubuntu

"nice" python upgrade script

=== Arch

"rolling" release => only current version of everything is supported, so you have to upgrade everything if you want to add/upgrade a single package
non-split packages: have everything usually (dev, libs, docs, plugins, etc)

=== Ångström

=== Gentoo?

=== Cent OS

=== SUSE

=== Be OS

=== Windows 95

=== Windows NT

==== Prevail

pkgs, reputation

==== Distros

LFS
Gentoo
Gobolinux: no Unix FSH
Angstrom
T2 SDE
Fedora (RPM)
BSD
Haiku: no Unix FSH
Minix
Nixos

= VCS

Rebase, cherry-pick, revert, svn merge are all similar things: Graft or transplant (copies of) parts of one history onto another history.
Explicit file history is useful
Reverts should allow a change to be re-merged

git rebase --onto NEW UPSTREAM [BRANCH]
BRANCH default is what's checked out
NEW default is UPSTREAM
git rebase --onto APPLY-POINT NOT-IN [FROM]
git rebase --onto DEST COMPARE [SOURCE]
git rebase --onto GRAFT-POINT FROM-TRUNK [GRAFT-BRANCH]

==== CD ripping

http://www.exactaudiocopy.de/en/index.php/resources/download/
http://wiki.dennyhalim.com/secure-ripping-on-linux
http://thomas.apestaart.org/morituri/trac
https://thomas.apestaart.org/thomas/trac/wiki/DAD/Rip
https://gna.org/projects/cued
http://wiki.hydrogenaudio.org/index.php?title=Comparison_of_CD_rippers
http://www.cuetools.net/
http://sbooth.org/Rip/

apparently bloc party's album has a hidden track ("eating glass" or something?); check the cue sheets

=== Accurate rip

http://www.accuraterip.com/
http://code.google.com/p/rubyripper/wiki/AccurateRip_Research
http://jonls.dk/2009/10/calculating-accuraterip-checksums/
http://db.cuetools.net/
http://www.hydrogenaudio.org/forums/index.php?showtopic=79882 Cue tools DB announcement

http://club.cdfreaks.com/showthread.php?t=111913
= <http://club.myce.com/f61/offsets-handling-syncing-audio-data-vs-q-channel-111913/>
EAC and Accurate rip (and DB power amp?) offset corrections o; Perfect rip offset (compensation?) = -(o - 30)
"True" EAC offset = Common (AR) offset - 30
Plex tools (read offset) is negative of EAC (read offset correction) too; plex tools offset feature added after EAC (?).

AR offset (correction) + => read lead-out; - => read lead-in

== Implementations

http://forum.dbpoweramp.com/showthread.php?t=20641 Accurate rip code
http://www.hydrogenaudio.org/forums/index.php?showtopic=53583 ARCue.pl
http://www.srcf.ucam.org/~cjk32/ARCue/ARCue.pl
http://www.hydrogenaudio.org/forums/index.php?showtopic=62522 ARFlac.pl
ARCue + exe is buggy
http://www.cuetools.net/
comes with arcuedotnet.exe cli
http://jonls.dk/2010/10/accuraterip-tools/ also does EAC CRC32s
https://github.com/jonls/accuraterip-tools
http://thomas.apestaart.org/morituri/trac/browser/trunk/examples/ARcue.py
http://thomas.apestaart.org/morituri/trac/browser/trunk/morituri/common/accurip.py
http://cvs.gna.org/cvsweb/cued/accurip/notdown (ruby + C implementation)
XLD (mac only? web page gone?)
http://sbooth.org/Rip/ (mac only)
http://www.hydrogenaudio.org/forums/index.php?showtopic=61574 ARFlac C port

arcue: pl script (original). Needs LWP (Perl WWW library).
arflac.pl and C?
accuraterip-tools
morituri: rip image verify

=== Drives

Matshita (Panasonic) DVD-RAM UJ880AS
Offset: +102 [AR: 64 submissions, 100% agreement]
No lead-out overread ability [EAC]
Accurate stream, no audio cache, no C2 pointers [EAC]

TEAC CD-220EA
Offset: +684 [AR: 1 submission, 100% agreement]
C2 pointers, accurate stream, no audio cache [EAC]

Matshita (Panasonic) DVD/CDRW UJDA770
Offset: +102 [AR: 29 submissionss, 100% agreement]
Accurate stream, defeat audio cache, no C2 pointers [EAC]

JLMS XJ-HD165H CH11: +12 AR correction offset

====

Ranger file manager, qtfm
build pkgbuild on ubuntu?

= vobsub subtitles

mplayer's view is that ifo file is required as well as idx, to provide colours/palette
however it looks like this info may be in the idx file

Remove "sed" command on "makefile"
Run "make install" which now automatically installs the GUI. Just needs a bit of cleaning up after it.

= CD ripping

rubyripper ? May not include full indexes in cue?
cdrdao: toc gets some things, inconsistencies with others, funny isrc behaviour without "fast toc"
cdparanoia: doesn't get much toc info
is cue enough to encapsulate what I want? (I hope so)
abcde: does cue files + cdparanoia
cdparanoia "[::]-"
what about cds that have data tracks?
multi-disc sets: use "DISC" tag

= Knowledge base

== Requirements

Syntax is easy to remember (don't need Google how to do things all the time)
Syntax is easy to read in plain text
Syntax is easy to type (XML/HTML/SGML can be awkward)
Syntax is obvious (so you can paste things in plain text and easily see that they don't need encoding)
Syntax gracefully degrades, so local errors do not obscure the whole file
Compatible with plain text files so that svn blame, diff, etc works

== Implementations

http://wikidpad.sourceforge.net/

=== Gnu C library

Using a different version:
LD_PRELOAD="$OTHER/lib/libc-2.12.2.so" "$OTHER/lib/ld-linux.so.3" "$OTHER/usr/bin/ubiattach"

or replace both ld and libc (just replacing one causes everything to segfault!)
Probably using a shell script won't work, you'd have to have both replaced by a single command (process).

This almost worked I think, but I ran out of space:
tar -C / -xjvf Angstrom-aegle-image-eglibc-ipk-next-beagleboard.rootfs.tar.bz2 "./lib/ld*" "./lib/libc.*" "./lib/libc-*"

= Applications

see ~/TODO

If you're an end user who is actively looking for an IMAP e-mail client, please note that Trojitá's GUI is not completely ready for mass consumption yet (read: needs some polishing to not scare users away). If you are scared now, please come back in a few months, you might be pleasantly surprised :)
Resources
Source Code
== PDF browsers

???

== Email

Thunderbird
Kmail (part of KDE + Kcontact or something)
Sylpheed (GTK+)
Claws mail (forked from Sylpheed) odd server port settings; dumb mandatory "wizard"; decided to spend ages (downloading?) all 43 thousand of my messages, but seemed to forget about that after I killed and restarted; uses GTK; slow if you accidentally click out of "Inbox" and back again
Mahogany: horrible ass-uming Configure script; failed to compile (x86-64?)
Gnu mail (gnumail)

= Software package description

== Source packages
linux
linux-omap
bitbake
quilt
gquilt
udev
python

== Source versions
2.6.n
2.6.n.m
2.6.n-rcX
2.6.38-rcX+gabcd
+full-path

== Target packages
linux
linux 2.6
linux 2.6.x. . .
linux-omap. . .
bitbake 1.10
quilt
quilt+debian
gquilt
udev
udev+full-path
python 2
python 2.6
python 2.7
python 3
arch-base
aegle-image
tuomov-b

== Ideas
One package P+variation, P-variation or P' may "provide" another package P's functionality, meaning anything requiring package P should work just as well with P+variation et al. However a package requiring P' won't necessarily work with P alone.

Package name has default provision

Source package generates many target packages

Different target "spaces": file system, kernel images (incl memtest etc); initramfs

Some packages and versions may be installed side-by-side (eg python2 and python3); some may conflict

Architectures and platforms; a bit like another version; if you can run arch x86_64 you may install x64_32 packages as well (but not kernel modules?); x86_64 would be prioritised though. Also windows packages may work via Wine; other architectures might work through an emulator like Qemu.

Various installation targets: file system; bootloader; random file (eg misc kernel image); tarball; staged file system, bootloader, etc. Not all targets would be valid for all packages.

Bringing common themes together: configure options; make options; the make install DESTDIR syntax. There should be a way to configure the default make -jN option; whether to enable or disable this by default would be contraversial.

report approx cpu usage (perhaps weighed against some bogomips-like standard), peak memory usage, peak disk usage, size of disk output

set disassembly-flavor intel
disp/i $eip
disas $eip,+0x100

git defaults:
git status -uno
--color=auto?
whitespace "errors"

= Python nits

Anonymous function, class, etc definitions: something like

increment = function(i):
    return i + 1
increment = def(i):
    return i + 1
increment = lambda i:
    return i + 1
sequence = generator(i):
    yield ...
ClassName = class(Base):
    ...

Surely anonymous definitions can be done better, and in such a way that special decorator syntax is no longer desirable. Also it would be nice to have the documentation string less inside the body and more associated with the decorated form and name. Might be tied up a little with the requirement for indentation.

super: the name is misleading, maybe worse. I'm not sure how okay it is to just ignore it.

"with" context manager stuff is better than nothing, but rather inflexible. What if you want to conditionally create the context object, but still execute the code block inside? How to properly make your own context objects, eg a file object wrapping open, making it immune to exceptions.

Inconsistencies with assignment operations to immutable objects

ctn = []; print(ctn)
tup = (ctn,); print(tup)
ctn.extend(["ctn.extend"]); print(ctn, tup)
ctn += ["ctn +="]; print(ctn, tup)
tup[0].extend(["tup[0].extend"]); print(ctn, tup)
tup[0] += ["tup[0] +="] # TypeError: 'tuple' object does not support item assignment
print("Container was modified before assignment attempt:", ctn, tup)

Also it's odd that list += x leaves (assigns) the same object identity, but int (or tuple) += x changes the identity.

= How to use command line

--help -h etc
getopt and gnu stuff
--
-v => verbose

= [re-import] Python reload module

import module
...
from imp import reload
reload(module)

= Yield leaks exception being handled

Doesn't appear to delete the exception variable unless the generator is called back into, as happens otherwise for return, break, continue, raise, fall through, double exception. Result is a reference cycle that needs garbage collecting. Even happens with anonymous exception handler.

from gc import set_debug, DEBUG_LEAK, collect
set_debug(DEBUG_LEAK)

def genfunc():
    try:
        raise Exception()
    except:
        yield
    finally:
        print("finally")

def start():
    g = genfunc()
    next(g)
    print(g.gi_frame, "line", g.gi_frame.f_lineno) # Frame is at yield line
    return g

# Throw leaks
g = start()
try:
    g.throw(Exception()) # Finally suite executed
except Exception:
    pass

del g
print(collect()) # Exception, traceback and frame leaked

# Close leaks
g = start()
g.close() # Finally
del g
print(collect()) # Leak

# Del leaks
g = start()
del g # Finally
print(collect()) # Leak

# Next cleans up successfully
g = start()
try:
    next(g) # Finally
except StopIteration:
    pass

del g
print(collect()) # Nothing

# Send okay
g = start()
try:
    g.send(None) # Finally
except StopIteration:
    pass

del g
print(collect()) # Nothing

= Similarly, how to use

gui
editor with vim keys

= LEDs

from math import (pi, cos)

def deg_rad(deg):
    return deg / 180 * pi

def deg_sr(deg):
    return 2 * pi * (1 - cos(deg_rad(deg) / 2))

def mcd_lm(mcd, deg):
    return mcd * 10 ** -3 * deg_sr(deg)

def chrom_cct_mccamy(chrom):
    e = [0.3320, 0.1858]
    n = (chrom[0] - e[0]) / (chrom[1] - e[1])
    return -449 * n ** 3 + 3525 * n ** 2 - 6823.3 * n + 5520.33

def chrom_cct_mccamy(chrom):
    e = [0.3320, 0.1858]
    n = (chrom[0] - e[0]) / (chrom[1] - e[1])
    return -449 * n ** 3 + 3525 * n ** 2 - 6823.3 * n + 5520.33

from math import exp

def chrom_cct_jha_low(chrom):
    e = [0.3320, 0.1858]
    A_0 = -949.86315
    A = [6253.80338, 28.70599, 0.00004]
    t = [0.92159, 0.20039, 0.07125]
    
    n = (chrom[0] - e[0]) / (chrom[1] - e[1])
    return A_0 + sum(A[i] * exp(-n * t[i]) for i in range(3))

def ct_chrom_kim(T):
    x = \
        -0.2661239e9 / T ** 3 - 0.2343580e6 / T ** 2 + 0.8776956e3 / T + 0.179910 if 1667 <= T < 4000 else \
        -3.0258469e9 / T ** 3 + 2.1070379e6 / T ** 2 + 0.2226347e3 / T + 0.240390 if 4000 <= T <= 25000
    y = \
        
AL-103W2C-004 10 mm 30 mA 80 mW 2.8–3.6 V 3500–6500 mcd 30° 0.75–1.39 lm chrom. (0.25,0.26) 17000 K 1000 h

= WEP cracking

sudo airmon-ng start wifi 11
sudo airodump-ng --write <name> --showack wifi --channel 11 --ivs --bssid AA:BB:CC:DD:EE:FF
-x msec?
sudo aireplay-ng wifi -3 -b AA:BB:CC:DD:EE:FF -e <string>
                         KEY FOUND! [ xx:xx:xx:xx:xx ] 

= Arch installation

FS=/home/os/arch-i686

sudo rm -r "$FS/m/sik/boot/arch-i686"
sudo umount "$FS/home" "$FS/m/sik"
sudo rm -r "$FS"

sudo mkdir -p "$FS"

sudo mkdir "$FS/media"
sudo ln -s media "$FS/m"

sudo mkdir "$FS/m/sik" "$FS/home"
sudo mount /dev/sda1 "$FS/m/sik"
sudo mount /dev/disk/by-label/HOME "$FS/home" -t ext2

sudo mkdir "$FS/m/sik/boot/arch-i686"
sudo ln -s m/sik/boot/arch-i686 "$FS/boot"
sudo chmod go+w "$FS/boot"  # Temporarily, to reduce the need for "sudo"

./pkgbundle fs "$FS" fs-sudo \
    repo 'http://mirrors.kernel.org/archlinux/core/os/$arch/core.db' \
    install base build mkinitcpio-dir \
    offline

sudo ${EDITOR-vi} "$FS/etc/mkinitcpio.conf"  # Add HOOKS="$HOOKS dir"

./mkinitcpio-cross "$FS" linux -v  # Previously kernel26


./mkinitcpio-cross "$FS" "$FS/etc/mkinitcpio.d/kernel26.preset" -v
(
    WD="$(pwd)" && cd "$FS/lib/initcpio" &&
    ALL_kver="$WD/mkinitcpio" -v \
        -p "etc/mkinitcpio.d/kernel26.preset" -b "$FS"
)
#-c "$FS/etc/mkinitcpio.conf" 
